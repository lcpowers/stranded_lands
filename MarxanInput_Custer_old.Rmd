

## Load data
```{r load_data}

# Conservation feature vs. planning unit
puvspr2 <- read_delim("../Marxan/R_output_files/MarxanInput_byCounty/CUSTER/puvspr2.dat",delim = " ")

# Conservation features
spec <- read_delim("../Marxan/R_output_files/MarxanInput_byCounty/CUSTER/spec.dat", delim = " ")

```


## Planning Unit File
### Total Value
```{r custer_pu}


## Attempting spatial join between custer county cadastral polygons and custer section polygons
cad_sec_join = st_join(x = st_as_sf(custer_cad_clean),y = custer_sections_sf, largest = T)

## Looks like all parcels joined. How many sections joined? 3778
length(unique(cad_sec_join$pu_id))

# # Export to see which sections didn't join and why
# writeOGR(as(cad_sec_join,"Spatial"),
#          dsn = "../R_output_files/scratch/",
#          layer = "cad_sec_join",
#          driver = "ESRI Shapefile")
# 
# Hard to see that way. Try filtering for the sections that are not represented in the original section file
# 
# PLSS_section_list = unique(custer_sections$pu_id) # 3923
# cad_join_section_list = unique(cad_sec_join$pu_id) # 3778. 145 missing
# 
# custer_section_fltr = st_as_sf(custer_sections) %>% 
#   filter(!(pu_id %in% cad_join_section_list)) # Fitler or sections that don't overlap 145
# 
# writeOGR(as(custer_section_fltr,"Spatial"),
#          "../R_output_files/scratch/",
#          "missing_sections",
#          "ESRI Shapefile")

## In both QGIS and R, when sections are cropped to county outlines, the programs keep the borders of some sections that are primarily in adjacent counties. When viewed in QGIS, this looks like lines right along the border, not complete sections. Therefore, it is a good thing that these sections are not brought in with the join as they should be dropped.

```

### Incorporating Urban areas and roads in the 'status' column -- Locked out = 3
```{r locked_out}
  

# To check in Qgis
# writeRaster(nlcd_urban,"../R_output_files/scratch/nlcd_urban.tif",overwrite=T)


# To check in QGIS
# writeOGR(obj = nlcd_urban_shp,
#          dsn = "../R_output_files/scratch/",
#          layer = "nlcd_urban_poly",
#          driver = "ESRI Shapefile")

## All Good!

## Read in roads
roads = readOGR("../R_output_files/transpo/roads_arterial_disag.shp")

## Merge roads and urban shapefiles as one 'lock out' shapefile
roads_urban_merge = raster::union(x = roads,y = nlcd_urban_shp)

## Simplify this attribute table to prepare it for a join to the PU shapefile
locked_out_sf = st_as_sf(roads_urban_merge) %>% 
  dplyr::select(geometry) %>% # Just keep the geometry column
  mutate(status = 3) # Create a new column with the "lock out" status

### Lock out roads and urban areas ###

## Spatial join between the urban-roads "lock out" shapefile and the PU shapefile
pu_status_sf = st_join(section_totalValue_sf, locked_out_sf, largest = T)

## Change NA values in the "status" column to 0
pu_status_sf$status = ifelse(is.na(pu_status_sf$status),0,3)

### Locked out other public land (not stranded) ###
custer_public <- custer_public_land %>% 
  filter(strandedal != 1)

custer_public$status = 3 # Lock out all public land from the solution

pad_slct_clean <- cleangeo::clgeo_Clean(as(pad_slct,"Spatial"))
pu_status_clean <- cleangeo::clgeo_Clean(as(pu_status_sf,"Spatial"))

pu_status_pad = st_join(st_as_sf(pu_status_clean), st_as_sf(custer_public),largest=T,suffix = c(".PU",".nonstranded"))

pu_status_pad$status = ifelse(pu_status_pad$status.y == 3,
                              pu_status_pad$status.y, 
                              pu_status_pad$status.x)

pu_status_pad$status = ifelse(is.na(pu_status_pad$status.y),
                              pu_status_pad$status.x,
                              pu_status_pad$status)

pu_status_pad = pu_status_pad %>% 
  dplyr::select(-status.x,-status.y)
```

## Incorporating stranded land in the 'status' column. In initial reserve but not necessarily in final reserve == 1
```{r stranded_status}

# Read in stranded land
stranded = readOGR("../R_output_files/stranded_shp/montana/mt_stranded.shp")

# Crop to custer county
custer_stranded = raster::intersect(stranded,as(custer_outline,"Spatial")) %>% 
  st_as_sf() %>% 
  dplyr::select(geometry) %>% 
  mutate(stranded_status = 1)

# Join the pu_status shapefile with the custer_stranded shapefile
custer_stranded_pu_join = st_join(pu_status_pad,custer_stranded,largest = T)

# If NA in Stranded Status column, keep the previous status. If not, aquire the stranded status
custer_stranded_pu_join$status = ifelse(is.na(custer_stranded_pu_join$stranded_status),
                                          custer_stranded_pu_join$status,
                                          custer_stranded_pu_join$stranded_status)

# Get rid of extra columns
custer_pu_file = custer_stranded_pu_join %>% 
  as.data.frame() %>% 
  dplyr::select(-stranded_status,-geometry,-GAP_Sts)

# Rename columns to match Marxan required column names
colnames(custer_pu_file) = c("id","cost","status")
```


## Writing R output for Marxan Input
```{r write_output_files}

# PU.dat file (planning unit file)
write_delim(custer_pu_file,"../Marxan/R_output_files/MarxanInput_byCounty/CUSTER/pu.dat",delim = " ")

# Get unique pu_ids from the Planning unit file
pu_ids = custer_pu_file$id

# Get rid of extra PUs from the PU-conservation feature file
puvspr2_fltr = puvspr2 %>% 
  filter(pu %in% pu_ids)

# Write PU-conservation feature file
write_delim(puvspr2_fltr,"../Marxan/R_output_files/MarxanInput_byCounty/CUSTER/puvspr2.dat",delim = " ")
```

```{r}

marxan_output = read_delim("../R_output_files/scratch/trial2_ssoln.txt",",")

colnames(marxan_output) <- c("pu_id",
                             "number")

custer_reserve = left_join(custer_sections_sf,
                           marxan_output)


writeOGR(as(custer_reserve,"Spatial"),
         "../R_output_files/scratch/",
         "custer_reserve1",
         "ESRI Shapefile",
         overwrite_layer = T)
```

mean cost of stranded land sections in Custer County is 162,051
mean cost of all sections in Custer County is 304,042 
Sum of stranded land sections is 226,547,328

```{r}
# Read in focal nodes and resistance layer for state of montana, then clip to custer county
mt_resistance = raster("../R_output_files/circuitscape/resistance/resistance_final.asc")
mt_pus = readOGR("../Marxan/R_output_files/PUs/sections_wPUid.shp")

custer_pus = st_intersection(st_as_sf(mt_pus),custer_outline) %>% 
  filter(pu_id %in% section_totalValue_sf$id)

custer_pu_centroids = st_centroid(st_as_sf(custer_pus))

# Crop to custer outline
custer_resistance = mask(crop(mt_resistance,as(custer_outline,"Spatial")),as(custer_outline,"Spatial"))

custer_core_node_ras = rasterize(as(custer_pu_centroids,"Spatial"), custer_resistance, field = 'pu_id', background = NA)
NAvalue(custer_core_node_ras) <- -9999
plot(custer_core_node_ras)

writeRaster(custer_core_node_ras,
            "../R_output_files/circuitscape/core_areas/custer_FN",
            format = "ascii",
            overwrite=T)

writeRaster(custer_resistance,
            "../R_output_files/circuitscape/core_areas/custer_resistance",
            format = "ascii",
            overwrite=T)
```

```{r}
valid_pus = as.double(custer_pu_centroids$pu_id)

# Boundary lengths AKA CWD between sections
pu_cwd = read_delim("../Marxan/R_input_files/boundary_data/test2_resistances_3columns.txt"," ") %>% 
  filter(id1 %in% pu_ids) %>% 
  filter(id2 %in% pu_ids)

write_delim(pu_cwd,"../Marxan/R_output_files/MarxanInput_byCounty/CUSTER/boundary.dat",delim = " ")

```
Need to lock out BLM files

```{r}
maps <- readOGR("~/Desktop/andrew_maps/redraft1 2/citycurb.shp")

plot(maps)
```

