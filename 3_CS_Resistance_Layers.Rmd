---
title: "3_CS_Resistance_Layers"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Packages and Working Directory
```{r load_packages}
library(raster)
library(tidyverse)
library(sf)
library(rgdal)
library(rgeos)
library(maptools)

# setwd("~/StrandedLand/stranded_repo") # Bren R server
setwd("~/Desktop/StrandedLand/stranded_repo") # Desktop
```

### Montana/County Outlines and NLCD data
```{r mt_outlines_and_NLCD}

# Get MT and GB NLCD raster data
mt_nlcd = raster("../R_output_files/nlcd/nlcd_mt.tif")
gb_nlcd = raster("../R_output_files/nlcd/nlcd_gb.tif")
# Change cells with 0 value to NA
values(mt_nlcd)[values(mt_nlcd)==0] <- NA

# Get stranded NLCD data
mt_stranded_nlcd = raster("../R_output_files/nlcd/nlcd_mt_stranded.tif")
gb_stranded_nlcd = raster("../R_output_files/nlcd/nlcd_gb_stranded.tif")

mt_counties <- readOGR("../R_input_files/mt_counties/gb_outline.shp")
mt_outline <- readOGR("../R_input_files/mt_outline/StateofMontana.shp") %>% 
  spTransform(.,crs(mt_nlcd))
```



### DEM Data: ###

* Read in files
* Merge into one raster layer
* put into mt_nlcd CRS
* Crop to mt_outline
* Mask to mt_outline
```{r get_dem}

timestamp()
dem_list <- list.files(path = "../R_input_files/dem",recursive = T,full.names = T)
dem_rasters <- lapply(dem_list, raster)

timestamp()
# Merge each dem file into one raster layer
dem <- do.call(merge,dem_rasters) # This takes a while...but it works!

timestamp()
# Reproject dem
pr <- projection(mt_nlcd)
dem_proj = projectRaster(dem,crs = pr) # This also takes a while...
writeRaster(dem_proj,"../R_output_files/DEM/dem_reproj.tif")

timestamp()
# Crop to mt outlines
dem_crop = crop(dem_proj,mt_outline) 
writeRaster(dem_crop,"../R_output_files/DEM/dem_crop.tif")

timestamp()
beginCluster(10)
dem_mask = clusterR(dem_crop,mask,args = list(mt_outline))
endCluster()
writeRaster(dem_mask,"../R_output_files/DEM/mt_mask.tif")
timestamp()

timestamp()
beginCluster(10)
mt_slope <- clusterR(dem_mask,terrain,args = list(unit='degrees'))
endCluster()
writeRaster(mt_slope,"../R_output_files/DEM/slope.tif")


timestamp()
mt_slope_rsmpl <- resample(mt_slope,mt_nlcd)
writeRaster(mt_slope_rsmpl,"../R_output_files/DEM/mt_slope_r.tif")

  
```


### Roads

#### Roads Filter
```{r get_data}

# Read in Montana Transportation (Roads) shapefile
roads = readOGR("../R_input_files/mt_transpo/Roads.shp") %>% 
  st_as_sf() %>% 
  st_simplify() 

roads_df <- roads %>% 
  as.data.frame() %>% 
  select(System,SystemClas,ROADTYPE) %>% 
  group_by(ROADTYPE,System,SystemClas) %>% 
  summarise(n_type = n()) %>% 
  ungroup() %>%
  filter(ROADTYPE != 'NA') %>% 
  arrange(-n_type)

roads_fltr <- roads %>% 
  select(System,SystemClas,ROADTYPE) %>% 
  

timestamp()
roads_merge <- roads_fltr %>% 
  group_by(System,SystemClas) %>% 
  summarise() %>% 
  as(.,"Spatial")
timestamp()

writeOGR(obj = roads_merge, 
         dsn =  "../R_output_files/transpo/", 
         layer = "roads_fltr_shp",
         driver = "ESRI Shapefile")

```

#### Roads Buffer
```{r}

roads_merge <- readOGR("../R_output_files/transpo/roads_fltr_shp.shp")

roads_merge_sf = st_as_sf(roads_merge) %>% 
  filter(SystemClas!=95 & System != 'NA')

table(roads_merge$SystemClas)

```


