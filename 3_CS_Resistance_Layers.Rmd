---
title: "Preparing resistance layers for Circuitscape"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### 1. Packages and data
```{r package_data}

library(raster)
library(tidyverse)
library(sf)
library(rgdal)
library(rgeos)
library(maptools)

mt_nlcd = raster("../R_output_files/nlcd/nlcd_mt.tif")
values(mt_nlcd)[values(mt_nlcd)==0] <- NA

mt_stranded_nlcd = raster("../R_output_files/nlcd/nlcd_mt_stranded.tif")
gb_nlcd = raster("../R_output_files/nlcd/nlcd_gb.tif")
gb_stranded_nlcd = raster("../R_output_files/nlcd/nlcd_gb_stranded.tif")

roads = readOGR("../R_input_files/mt_transpo/Roads.shp") %>% 
  spTransform(.,crs(mt_nlcd)) %>% 
  st_as_sf()

```

### 2. Creating buffered roads raster
```{r}

## Major Interstates
roads_NHS = roads %>% 
  # Filter Roads shapefile for major interstates
  filter(ROADTYPE == "NHS INTERSTATE") %>% 
  # Select useful attributes
  select(SOURCEID,ROADTYPE) %>% 
  # Turn back into spatial lines
  as(.,"Spatial") %>% 
  gLineMerge()

# Add a 200-m buffer
roads_NHS_buffer = gBuffer(roads_NHS,width = 200) %>% 
  st_as_sf()

## Major Highways
roads_PA = roads %>% 
  filter(ROADTYPE == "PRINCIPAL ARTERIAL") %>% 
  select(SOURCEID,ROADTYPE) %>% 
  as(.,"Spatial") %>% 
  gLineMerge()

roads_PA_buffer = gBuffer(roads_PA,width=100) %>% 
  st_as_sf()

## Combine NHS interstate and other highway spatial lines files
roads_buffer = rbind(roads_NHS_buffer,roads_PA_buffer) %>% 
  as(.,"Spatial")

# ras <- mt_nlcd
# ras[] <- NA

roads_raster = rasterize(x = roads_buffer,y = ras,field = 1)

plot(roads_buffer)
plot(roads_raster,add=TRUE,col="red")

# dir.create("../R_output_files/transpo/shp",recursive = T)

# writeOGR(obj = roads_buffer,
#          dsn = "../R_output_files/transpo/shp/",
#          layer = "roads_buffer",
#          driver = "ESRI Shapefile",
#          overwrite = T)

writeRaster(roads_raster,"../R_output_files/transpo/roads_raster.tif",overwrite = TRUE)
```

### 3. Reclassifying NLCD for Circsuitscape Resistances
```{r reclass_for_CS}
dir.create("../R_output_files/circuitscape/resistance/", recursive = T)

resistance_1 <- mt_nlcd
values(resistance_1)[values(resistance_1)>0] <- 1


cs_rcl_mat <- c(-Inf,11.5,0,
                     11.5,12.5,24, # Perennial ice/snow is low resistance
                     19,21,60,
                     24,26,80,
                     29,31,24,
                     39,41,7,
                     49,51,5,
                     59,61,17,
                     79,81,61,
                     89,91,11)

resistance_nlcd <- reclassify(mt_nlcd, rcl = cs_rcl_mat)

values(roads_raster)[values(roads_raster)>0] <- 100
resistance_roads_nlcd <- cover(roads_raster, resistance_nlcd)

resistance_roads_nlcd <- reclassify(resistance_roads_nlcd,c(NA,-9999))

writeRaster(resistance_nlcd,"../R_output_files/circuitscape/resistance/resistance_nlcd.asc",format = "ascii", overwrite = T)
writeRaster(resistance_roads_nlcd,"../R_output_files/circuitscape/resistance/resistance_roads_nlcd.asc",format = "ascii", overwrite = T)
writeRaster(resistance_1,"../R_output_files/circuitscape/resistance/resistance_1.asc", format = "ascii", overwrite = T)
```

