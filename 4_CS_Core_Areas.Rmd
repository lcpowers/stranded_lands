---
title: "Preparing core area layers for Circuitscape"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### 1. Packages and data
```{r packages_data}

library(tidyverse)
library(rgdal)
library(raster)
library(sf)
library(parallel)
library(rgeos)
library(cleangeo)

# setwd("~/StrandedLand/stranded_repo") # Bren R server
setwd("~/Desktop/StrandedLand/stranded_repo") # Desktop

# NLCD MT raster
nlcd_mt <- raster("../R_output_files/nlcd/nlcd_mt.tif")

# Gallatin-Broadwater Outline
gb_outline <- readOGR("../R_input_files/mt_counties/gb_outline.shp") %>% 
  st_as_sf()

# Montana Outline
mt_outline <- readOGR("../R_input_files/mt_outline/StateofMontana.shp") %>% 
  spTransform(.,crs(nlcd_mt)) %>% 
  st_as_sf()

# Protected Areas Shapefile
pad <- readOGR("../R_input_files/mt_pad/PADUS2_0Designation_MT.shp") %>% 
  spTransform(.,crs(nlcd_mt))

```

### 2. Creating Core Areas
```{r core_areas}

### Clean geometries before doing anything else to shapefile.
pad_clean = cleangeo::clgeo_Clean(pad)

### Filter PAD shapefile
pad_fltr = pad_clean %>% 
  st_as_sf() %>% 
  st_simplify() %>% 
  dplyr::select(GAP_Sts,d_GAP_Sts,IUCN_Cat, GIS_Acres) %>% 
  dplyr::filter(GAP_Sts == 1|GAP_Sts == 2) 

# Convert GIS_Acres column to numeric and filter it
# pad_fltr$GIS_Acres = as.numeric(pad_fltr$GIS_Acres)

# To be used in the 
pad_fltr$dissolve = rep(1,nrow(pad_fltr))

### Back into spatial object
pad_shp = as(pad_fltr,"Spatial") 

pad_pBuf = gBuffer(pad_shp,byid=TRUE,width = 500)
pad_union = unionSpatialPolygons(pad_pBuf,IDs = pad_pBuf@data$dissolve)
pad_nBuf = gBuffer(pad_union,byid = TRUE,width = -500) %>% 
  as(.,"SpatialPolygonsDataFrame")

#### Individual polygons ####
pad_disagg_sf = disaggregate(pad_nBuf) %>% 
  st_as_sf() 

pad_disagg_sf$area <- as.numeric(st_area(pad_disagg_sf)*0.000247105)

pad_disagg <- dplyr::filter(pad_disagg_sf, area > 10000) %>% 
  mutate(Core_ID = seq(1:nrow(.))) %>% 
  as(.,"Spatial")

pad_centroids = st_centroid(st_as_sf(pad_disagg)) %>% 
  mutate(ras_value = 1,
         core_id = seq(1:n())) %>%
  dplyr::select(core_id) %>% 
  as(.,"Spatial") 
```

### Write Shapefiles
```{r write_cores}
writeOGR(obj = pad_disagg, 
         dsn =  "../R_output_files/circuitscape/core_areas/PAD/",
         layer = "mt_core_area_polys",
         driver = "ESRI Shapefile",
         overwrite = T)

writeOGR(obj = pad_centroids, 
         dsn =  "../R_output_files/circuitscape/core_areas/PAD/",
         layer = "mt_core_area_pts",
         driver = "ESRI Shapefile",
         overwrite=T)
```

### Rasterize centroids
```{r}

core_node_ras = rasterize(pad_centroids, nlcd_mt, field = 'core_id', background = NA)

# Look at raster values to make sure the core nodes go from 1:46
core_node_df = as.data.frame(core_node_ras)

NAvalue(core_node_ras) <- -9999

writeRaster(core_node_ras,"../R_output_files/circuitscape/core_nodes",format = "ascii",overwrite=TRUE)

```

